<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devalley Web Editor v5.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #d4d4d4;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        button {
            padding: 10px 20px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        button:hover:not(:disabled) {
            background-color: #444;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.primary {
            background-color: #0e639c;
        }

        button.primary:hover:not(:disabled) {
            background-color: #1177bb;
        }

        #fileInfo {
            margin-left: auto;
            color: #aaaaaa;
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background-color: #1e1e1e;
            border-bottom: 2px solid #333;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            color: #999;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            background-color: #252525;
            color: #d4d4d4;
        }

        .tab.active {
            background-color: #252525;
            color: #569cd6;
            border-bottom-color: #569cd6;
            font-weight: bold;
        }

        /* Main Layout */
        .content-area {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .content-area.active {
            display: flex;
        }

        .sidebar {
            width: 350px;
            border-right: 1px solid #333;
            background-color: #1e1e1e;
            overflow-y: auto;
        }

        .main-view {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #121212;
        }

        label {
            color: #aaaaaa;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .list-item {
            padding: 12px 15px;
            border-bottom: 1px solid #2a2a2a;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background-color 0.2s;
            color: #d4d4d4;
        }

        .list-item:hover {
            background-color: #252525;
        }

        .list-item.selected {
            background-color: #007acc;
            color: white;
        }

        .modified {
            color: #f48771;
            font-weight: bold;
        }

        textarea {
            flex: 1;
            background-color: #1e1e1e;
            color: #9cdcfe;
            border: 1px solid #333;
            border-radius: 5px;
            font-family: 'Consolas', 'Courier New', monospace;
            padding: 15px;
            font-size: 14px;
            resize: none;
            line-height: 1.6;
        }

        textarea:focus {
            outline: none;
            border-color: #007acc;
        }

        #imagePreviewContainer {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #1e1e1e;
            position: relative;
            min-height: 400px;
        }

        #imagePreview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #imgMeta {
            color: #aaaaaa;
            font-size: 13px;
            padding: 10px;
            background-color: #252525;
            border-radius: 4px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        /* Scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div class="toolbar">
    <button class="primary" onclick="document.getElementById('fileInput').click()">üìÇ Abrir Arquivo</button>
    <button id="saveBtn" onclick="saveFile()" disabled>üíæ Salvar Como...</button>
    <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(this)">
    <div id="fileInfo">Nenhum arquivo carregado</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('text')">‚úèÔ∏è Editor de Texto</div>
    <div class="tab" onclick="switchTab('image')">üñºÔ∏è Editor de Imagem</div>
</div>

<div id="textTab" class="content-area active">
    <div class="sidebar" id="textList">
        <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>Nenhum arquivo carregado</p>
        </div>
    </div>
    <div class="main-view">
        <label>Conte√∫do do Bloco:</label>
        <textarea id="textEditor" placeholder="Selecione um bloco de texto para editar..." oninput="updateCurrentTextBlock()"></textarea>
    </div>
</div>

<div id="imageTab" class="content-area">
    <div class="sidebar" id="imageList">
        <div class="empty-state">
            <div class="empty-state-icon">üñºÔ∏è</div>
            <p>Nenhum arquivo carregado</p>
        </div>
    </div>
    <div class="main-view">
        <div id="imgMeta">Selecione um recurso de imagem</div>
        <div id="imagePreviewContainer">
            <img id="imagePreview" alt="">
        </div>
        <button onclick="document.getElementById('pngInput').click()">üîÑ Substituir PNG</button>
        <input type="file" id="pngInput" class="hidden" accept="image/png" onchange="replaceImage(this)">
    </div>
</div>

<script>
    let currentFileData = null;
    let textBlocks = [];
    let imageBlocks = [];
    let currentMode = 'text';
    let selectedIndex = -1;
    let fileName = "";

    const FILE_ENCODING = "iso-8859-1";

    function switchTab(tab) {
        currentMode = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
        
        if(tab === 'text') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('textTab').classList.add('active');
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('imageTab').classList.add('active');
        }
        selectedIndex = -1;
        renderLists();
    }

    async function handleFileSelect(input) {
        const file = input.files[0];
        if (!file) return;
        fileName = file.name;
        const buffer = await file.arrayBuffer();
        currentFileData = new Uint8Array(buffer);
        
        parseBinary();
        document.getElementById('saveBtn').disabled = false;
        renderLists();
    }

    function parseBinary() {
        const view = new DataView(currentFileData.buffer);
        const offsetCount = view.getUint32(0, true);
        const offsets = [];
        for (let i = 0; i <= offsetCount; i++) {
            offsets.push(view.getUint32(4 + i * 4, true));
        }

        textBlocks = [];
        for (let i = 1; i < offsets.length - 1; i++) {
            const start = offsets[i];
            const end = offsets[i+1];
            const slice = currentFileData.slice(start + 1, end - 1);
            const decoder = new TextDecoder(FILE_ENCODING);
            textBlocks.push({
                text: decoder.decode(slice).replace(/\0/g, ''),
                start: start,
                end: end,
                modified: false
            });
        }

        imageBlocks = [];
        for (let i = 0; i < offsetCount; i++) {
            imageBlocks.push({
                data: currentFileData.slice(offsets[i], offsets[i+1]),
                modified: false
            });
        }

        document.getElementById('fileInfo').innerText = `${fileName} | ${offsetCount} Blocos`;
    }

    function renderLists() {
        if (currentMode === 'text') {
            const list = document.getElementById('textList');
            if (textBlocks.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>Nenhum bloco de texto encontrado</p>
                    </div>
                `;
            } else {
                list.innerHTML = textBlocks.map((b, i) => `
                    <div class="list-item ${selectedIndex === i ? 'selected' : ''}" onclick="selectItem(${i})">
                        Bloco ${i}: <span class="${b.modified ? 'modified' : ''}">${b.text.substring(0, 30)}...</span>
                    </div>
                `).join('');
            }
        } else {
            const list = document.getElementById('imageList');
            if (imageBlocks.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üñºÔ∏è</div>
                        <p>Nenhum recurso de imagem encontrado</p>
                    </div>
                `;
            } else {
                list.innerHTML = imageBlocks.map((b, i) => `
                    <div class="list-item ${selectedIndex === i ? 'selected' : ''}" onclick="selectItem(${i})">
                        Recurso ${i.toString().padStart(3, '0')} ${b.modified ? '<span class="modified">[Modificado]</span>' : ''}
                    </div>
                `).join('');
            }
        }
    }

    function selectItem(index) {
        selectedIndex = index;
        renderLists();

        if (currentMode === 'text') {
            document.getElementById('textEditor').value = textBlocks[index].text;
        } else {
            displayImage(index);
        }
    }

    function updateCurrentTextBlock() {
        if (selectedIndex === -1) return;
        const newText = document.getElementById('textEditor').value;
        if (textBlocks[selectedIndex].text !== newText) {
            textBlocks[selectedIndex].text = newText;
            textBlocks[selectedIndex].modified = true;
        }
    }

    function displayImage(index) {
        const block = imageBlocks[index].data;
        const pngSig = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A];
        let startPos = -1;

        for (let i = 0; i < block.length - 8; i++) {
            if (pngSig.every((sig, j) => block[i + j] === sig)) {
                startPos = i;
                break;
            }
        }

        const imgEl = document.getElementById('imagePreview');
        const metaEl = document.getElementById('imgMeta');

        if (startPos !== -1) {
            const pngData = block.slice(startPos);
            const blob = new Blob([pngData], { type: 'image/png' });
            imgEl.src = URL.createObjectURL(blob);
            metaEl.innerText = `‚úÖ PNG encontrado no offset +${startPos} bytes`;
        } else {
            imgEl.src = "";
            metaEl.innerText = "‚ö†Ô∏è Nenhuma assinatura PNG encontrada neste recurso";
        }
    }

    async function replaceImage(input) {
        if (selectedIndex === -1) return;
        const file = input.files[0];
        if (!file) return;
        
        const newPngBuffer = new Uint8Array(await file.arrayBuffer());
        
        const originalBlock = imageBlocks[selectedIndex].data;
        const pngSig = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A];
        let startPos = -1;

        for (let i = 0; i < originalBlock.length - 8; i++) {
            if (pngSig.every((sig, j) => originalBlock[i + j] === sig)) {
                startPos = i;
                break;
            }
        }

        let newBlock;
        if (startPos !== -1) {
            let header = originalBlock.slice(0, startPos);
            if (header.length >= 4) {
                const sizeView = new DataView(header.buffer, header.byteOffset, header.byteLength);
                sizeView.setUint32(header.length - 4, newPngBuffer.length + 12, true);
            }
            newBlock = new Uint8Array(header.length + newPngBuffer.length);
            newBlock.set(header);
            newBlock.set(newPngBuffer, header.length);
        } else {
            newBlock = newPngBuffer;
        }

        imageBlocks[selectedIndex].data = newBlock;
        imageBlocks[selectedIndex].modified = true;
        displayImage(selectedIndex);
        renderLists();
    }

    function saveFile() {
        const blocksToUse = (currentMode === 'text') ? rebuildTextToBinary() : imageBlocks.map(b => b.data);
        
        const offsetCount = blocksToUse.length;
        let headerSize = 4 + (offsetCount + 1) * 4;
        
        let currentOffset = headerSize;
        const newOffsets = [];
        const paddedBlocks = blocksToUse.map(block => {
            newOffsets.push(currentOffset);
            const padding = (4 - (block.length % 4)) % 4;
            const padded = new Uint8Array(block.length + padding);
            padded.set(block);
            currentOffset += padded.length;
            return padded;
        });
        newOffsets.push(currentOffset);

        const finalBuffer = new Uint8Array(currentOffset);
        const view = new DataView(finalBuffer.buffer);
        
        view.setUint32(0, offsetCount, true);
        newOffsets.forEach((off, i) => view.setUint32(4 + i * 4, off, true));
        
        let cursor = headerSize;
        paddedBlocks.forEach(block => {
            finalBuffer.set(block, cursor);
            cursor += block.length;
        });

        const blob = new Blob([finalBuffer], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "edited_" + fileName;
        link.click();
        
        alert('‚úÖ Arquivo salvo com sucesso!');
    }

    function rebuildTextToBinary() {
        const blocks = [];
        blocks.push(imageBlocks[0].data); 
        
        textBlocks.forEach(tb => {
            const encoder = new TextEncoder();
            const textBytes = encoder.encode(tb.text);
            const fullBlock = new Uint8Array(textBytes.length + 2);
            fullBlock[0] = 0;
            fullBlock.set(textBytes, 1);
            fullBlock[fullBlock.length - 1] = 0;
            blocks.push(fullBlock);
        });
        return blocks;
    }
</script>

</body>
</html>
