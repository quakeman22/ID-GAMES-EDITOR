<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asterix Studio Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #121212;
            color: #d4d4d4;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            margin-top: 5px;
        }

        .tab-bar {
            display: flex;
            background-color: #1e1e1e;
            border-bottom: 2px solid #333;
            position: sticky;
            top: 70px;
            z-index: 99;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background-color: #252525;
        }

        .content {
            padding: 15px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .label {
            color: #aaaaaa;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        select {
            width: 100%;
            padding: 12px;
            background-color: #333;
            color: white;
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 16px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%);
            box-shadow: 0 4px 12px rgba(71, 85, 105, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        input[type="file"] {
            display: none;
        }

        .block-list {
            background-color: #252525;
            border-radius: 8px;
            overflow: hidden;
        }

        .block-item {
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .block-item:last-child {
            border-bottom: none;
        }

        .block-item.selected {
            background-color: #007acc;
        }

        .block-type {
            font-weight: bold;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #333;
        }

        .block-type.PNG {
            background-color: #059669;
            color: white;
        }

        .block-type.TXT {
            background-color: #3b82f6;
            color: white;
        }

        .block-type.SISTEMA {
            background-color: #dc2626;
            color: white;
        }

        .block-size {
            color: #999;
            font-size: 12px;
        }

        .status-bar {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            padding: 12px 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            color: white;
            margin-bottom: 15px;
            font-size: 14px;
        }

        textarea {
            width: 100%;
            min-height: 400px;
            background-color: #1e1e1e;
            color: #9cdcfe;
            border: 1px solid #333;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            padding: 15px;
            font-size: 14px;
            resize: vertical;
        }

        .image-container {
            background-color: #252525;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-container img {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            background-color: #3b82f6;
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéÆ Asterix Studio</h1>
        <div class="header-subtitle">Editor Mobile Multi-Game</div>
    </div>

    <div class="tab-bar">
        <div class="tab active" onclick="switchTab('files')">üìÅ Arquivos</div>
        <div class="tab" onclick="switchTab('editor')">‚úèÔ∏è Editor</div>
    </div>

    <div class="content">
        <!-- SE√á√ÉO ARQUIVOS -->
        <div id="files-section" class="section active">
            <div class="card">
                <div class="label">Perfil do Jogo</div>
                <select id="gameProfile">
                    <option value="vikings">Asterix e os Vikings</option>
                    <option value="obelix">Asterix Resgata Obelix</option>
                </select>
            </div>

            <div class="card">
                <input type="file" id="fileInput" accept="*">
                <button class="btn" onclick="document.getElementById('fileInput').click()">üìÇ Abrir Arquivo</button>
            </div>

            <div class="card">
                <div class="label">Blocos do Arquivo <span class="badge" id="blockCount">0</span></div>
                <div class="block-list" id="blockList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <p>Nenhum arquivo carregado</p>
                    </div>
                </div>
            </div>

            <button class="btn btn-success" id="saveBtn">üíæ Salvar Bin√°rio Final</button>
        </div>

        <!-- SE√á√ÉO EDITOR -->
        <div id="editor-section" class="section">
            <div class="status-bar" id="status">Selecione um bloco</div>

            <div id="imageEditor" class="hidden">
                <div class="button-group">
                    <button class="btn btn-secondary" id="replaceImgBtn">üñºÔ∏è Substituir</button>
                    <button class="btn btn-secondary" id="exportImgBtn">üíæ Exportar</button>
                </div>
                <div class="card">
                    <div class="image-container">
                        <img id="imageDisplay" src="" alt="Preview">
                    </div>
                </div>
            </div>

            <div id="textEditor" class="hidden">
                <div class="card">
                    <div class="label">Editor de Texto</div>
                    <textarea id="textArea" placeholder="Edite o texto aqui..."></textarea>
                </div>
            </div>

            <div id="systemEditor" class="hidden">
                <div class="card">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîí</div>
                        <p><strong>Bloco Protegido</strong></p>
                        <p style="margin-top: 10px; color: #888;">Este bloco n√£o pode ser editado</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const gameProfiles = {
            vikings: {
                name: "Asterix e os Vikings",
                headerEnd: 0x278,
                protecaoInicio: 0x2520,
                protecaoFim: 0x992C
            },
            obelix: {
                name: "Asterix Resgata Obelix",
                headerEnd: 0x278,
                protecaoInicio: 0xCD1,
                protecaoFim: 0x10D33
            }
        };

        let currentProfile = 'vikings';
        let blocks = [];
        let currentIndex = -1;
        let fileData = null;
        let fixedHeader = null;

        const elements = {
            gameProfile: document.getElementById('gameProfile'),
            fileInput: document.getElementById('fileInput'),
            blockList: document.getElementById('blockList'),
            blockCount: document.getElementById('blockCount'),
            saveBtn: document.getElementById('saveBtn'),
            status: document.getElementById('status'),
            imageEditor: document.getElementById('imageEditor'),
            textEditor: document.getElementById('textEditor'),
            systemEditor: document.getElementById('systemEditor'),
            imageDisplay: document.getElementById('imageDisplay'),
            textArea: document.getElementById('textArea'),
            replaceImgBtn: document.getElementById('replaceImgBtn'),
            exportImgBtn: document.getElementById('exportImgBtn')
        };

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById(`${tab}-section`).classList.add('active');
        }

        elements.gameProfile.addEventListener('change', (e) => {
            currentProfile = e.target.value;
        });

        elements.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadFile(file);
        });

        elements.textArea.addEventListener('input', autoSaveText);

        elements.replaceImgBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/png';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) replaceImage(file);
            };
            input.click();
        });

        elements.exportImgBtn.addEventListener('click', exportImage);
        elements.saveBtn.addEventListener('click', saveFile);

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                fileData = new Uint8Array(e.target.result);
                parseFile(fileData);
            };
            reader.readAsArrayBuffer(file);
        }

        function isPNG(data) {
            const pngSignature = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A];
            if (data.length < 8) return false;
            for (let i = 0; i < 8; i++) {
                if (data[i] !== pngSignature[i]) return false;
            }
            return true;
        }

        function hasSequence(arr, seq) {
            for (let i = 0; i < seq.length; i++) {
                if (i >= arr.length || arr[i] !== seq[i]) return false;
            }
            return true;
        }

        function parseFile(data) {
            const prof = gameProfiles[currentProfile];
            fixedHeader = data.slice(0, 4);
            blocks = [];
            elements.blockList.innerHTML = '';

            const pointers = [];
            for (let i = 4; i < prof.headerEnd; i += 4) {
                const ptr = readUInt32BE(data, i);
                if (ptr === 0 || ptr > data.length) break;
                pointers.push(ptr);
            }

            pointers.forEach((start, i) => {
                const end = i + 1 < pointers.length ? pointers[i + 1] : data.length;
                const raw = data.slice(start, end);
                
                let type;
                let content = raw;
                
                if (start >= prof.protecaoInicio && start <= prof.protecaoFim) {
                    type = 'SISTEMA';
                } else {
                    if (raw.length > 12 && isPNG(raw.slice(4))) {
                        type = 'PNG';
                        content = raw.slice(4);
                    } else if (hasSequence(raw.slice(0, 12), [0x51, 0x59, 0x50, 0x36])) {
                        type = 'QYP6';
                    } else if (raw.length > 2) {
                        type = 'TXT';
                        content = raw.slice(2);
                    } else {
                        type = 'SISTEMA';
                    }
                }

                blocks.push({ type, content, rawSize: raw.length });
                addBlockItem(type, raw.length, i);
            });

            elements.blockCount.textContent = blocks.length;
            
            // Mostra notifica√ß√£o
            if (blocks.length > 0) {
                alert(`‚úÖ Arquivo carregado com sucesso!\n${blocks.length} blocos encontrados`);
            }
        }

        function readUInt32BE(data, offset) {
            return (data[offset] << 24) | (data[offset + 1] << 16) | 
                   (data[offset + 2] << 8) | data[offset + 3];
        }

        function addBlockItem(type, size, index) {
            const item = document.createElement('div');
            item.className = 'block-item fade-in';
            item.innerHTML = `
                <div>
                    <span class="block-type ${type}">${type}</span>
                </div>
                <div class="block-size">${size} bytes</div>
            `;
            item.onclick = () => selectBlock(index);
            elements.blockList.appendChild(item);
        }

        function selectBlock(index) {
            autoSaveText();
            
            document.querySelectorAll('.block-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });

            currentIndex = index;
            const block = blocks[index];

            elements.imageEditor.classList.add('hidden');
            elements.textEditor.classList.add('hidden');
            elements.systemEditor.classList.add('hidden');

            if (block.type === 'PNG') {
                elements.status.textContent = 'üñºÔ∏è MODO: IMAGEM';
                const blob = new Blob([block.content], { type: 'image/png' });
                elements.imageDisplay.src = URL.createObjectURL(blob);
                elements.imageEditor.classList.remove('hidden');
            } else if (block.type === 'TXT') {
                elements.status.textContent = 'üìù MODO: TEXTO';
                const decoder = new TextDecoder('utf-8');
                elements.textArea.value = decoder.decode(block.content);
                elements.textEditor.classList.remove('hidden');
            } else {
                elements.status.textContent = `üîí ${block.type} (PROTEGIDO)`;
                elements.systemEditor.classList.remove('hidden');
            }

            // Muda para a aba do editor
            switchTab('editor');
            document.querySelectorAll('.tab')[1].classList.add('active');
        }

        function autoSaveText() {
            if (currentIndex !== -1 && blocks[currentIndex].type === 'TXT') {
                const encoder = new TextEncoder();
                blocks[currentIndex].content = encoder.encode(elements.textArea.value);
            }
        }

        function replaceImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                blocks[currentIndex].content = new Uint8Array(e.target.result);
                selectBlock(currentIndex);
                alert('‚úÖ Imagem substitu√≠da com sucesso!');
            };
            reader.readAsArrayBuffer(file);
        }

        function exportImage() {
            const blob = new Blob([blocks[currentIndex].content], { type: 'image/png' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `img_${currentIndex}.png`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveFile() {
            autoSaveText();
            
            if (blocks.length === 0) {
                alert('‚ùå Nenhum arquivo carregado!');
                return;
            }
            
            const prof = gameProfiles[currentProfile];
            
            const pool = [];
            const ptrs = [];
            let curr = prof.headerEnd;

            blocks.forEach(b => {
                ptrs.push(curr);
                let final;
                
                if (b.type === 'SISTEMA' || b.type === 'QYP6') {
                    final = b.content;
                } else if (b.type === 'PNG') {
                    const size = new Uint8Array(4);
                    new DataView(size.buffer).setUint32(0, b.content.length, false);
                    final = new Uint8Array([...size, ...b.content]);
                } else {
                    const size = new Uint8Array(2);
                    new DataView(size.buffer).setUint16(0, b.content.length, false);
                    final = new Uint8Array([...size, ...b.content]);
                }
                
                pool.push(...final);
                curr += final.length;
            });

            const output = new Uint8Array(prof.headerEnd + pool.length);
            output.set(fixedHeader, 0);
            
            ptrs.forEach((ptr, i) => {
                const view = new DataView(output.buffer);
                view.setUint32(4 + i * 4, ptr, false);
            });

            output.set(pool, prof.headerEnd);

            const blob = new Blob([output], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'asterix_modificado.bin';
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Bin√°rio reconstru√≠do com sucesso!');
        }
    </script>
</body>
</html>
